# Bitrix24 DocxToPdf Converter (Microservice Edition)

Этот проект представляет собой **локальный сервер конвертации документов** для Битрикс24 (Коробочная версия).
Он заменяет собой стандартный внешний конвертер Битрикс, позволяя генерировать PDF документы (Счета, Акты и т.д.) полностью на вашем сервере.

> **Модернизированная версия**: Полностью переписанная архитектура исходного проекта [Bitrix24DocxToPdf](https://github.com/AlexSuperStar/Bitrix24DocxToPdf). Добавлено:
> *   Поддержка Docker Compose «все-в-одном».
> *   **Совместимость с протоколом старых модулей Transformer** (трехэтапная загрузка).
> *   Gotenberg 8.x.
> *   Автоматический HTTPS через Caddy.

## Преимущества

1.  **Приватность**: Ваши документы не уходят во внешние облака.
2.  **Скорость**: Работает внутри вашей сети или на быстром VPS (время генерации ~2-4 сек).
3.  **Стабильность**: Использует промышленный движок **Gotenberg** (LibreOffice + Chrome API).
4.  **Простота**: Автоматическое получение **SSL сертификатов** (HTTPS) через Caddy. Не нужно настраивать Nginx.
5.  **Надежность**: Система очередей RabbitMQ гарантирует, что конвертация не "положит" ваш сервер при большой нагрузке.

---

## Требования

Для запуска вам понадобится отдельный сервер (VPS) с установленным Docker.
Подойдет любой сервер с Ubuntu 20.04/22.04 и минимум 2GB RAM (рекомендуется 4GB для тяжелых документов).

### Установка Docker (Ubuntu)
Если на сервере еще нет Docker, выполните команды:

```bash
# Установка Docker
curl -fsSL https://get.docker.com -o get-docker.sh
sudo sh get-docker.sh

# Установка Docker Compose
sudo apt-get update
sudo apt-get install docker-compose-plugin
```

---

## Установка и Запуск

Выполните эти команды на вашем сервере (под root или sudo):

### 1. Скачивание
Клонируйте репозиторий:
```bash
git clone https://github.com/ВашАккаунт/Bitrix24DocxToPdf.git
cd Bitrix24DocxToPdf
```

### 2. Настройка
Создайте файл настроек из примера:
```bash
cp .env.example .env
nano .env
```
Отредактируйте файл `.env`, указав ваш реальный домен и email (для уведомлений о сертификатах):
```dotenv
DOMAIN_NAME=pdf.your-company.ru
ACME_EMAIL=admin@your-company.ru
RABBITMQ_USER=user
RABBITMQ_PASS=secure_password
SECURITY_TOKEN=my_secret_token_abc123
```
*Важно: Домен должен быть направлен (A-запись DNS) на IP-адрес этого сервера, иначе SSL не выпустится.*

### 3. Запуск
```bash
docker compose up -d --build
```
Эта команда скачает все необходимые компоненты, соберет проект и запустит его. При первом запуске это займет пару минут.

Чтобы проверить, что все работает:
```bash
docker compose logs -f worker
```
Вы должны увидеть сообщение: `Connected. Listening on queue...`

---

## Подключение к Битрикс24

Вам нужно указать Битриксу использовать ваш новый сервер.

### 1. Через Админку (Основной способ)
Самый простой способ — изменить настройки через интерфейс администратора:
1.  Перейдите в **Администрирование** -> **Настройки** -> **Настройки продукта** -> **Настройки модулей**.
2.  Найдите модуль **Конвертер файлов (transformer)**.
3.  В поле "Путь к серверу" (URL) укажите адрес вашего сервера.
    *   Без токена: `https://pdf.your-company.ru/`
    *   **С токеном (Рекоммендуется):** `https://pdf.your-company.ru/?token=my_secret_token_abc123`
4.  Сохраните настройки.

### 2. Альтернатива: В файле .settings.php (Для разработчиков)
Этот способ является более приоритетным (перекрывает настройки в админке), но требует правки файлов на сервере (`/home/bitrix/www/bitrix/.settings.php`).

Добавьте или измените секцию `transformer`:

```php
'transformer' => [
    'value' => [
        'serviceUrl' => 'https://pdf.your-company.ru/', 
        'responseUrl' => 'https://адрес-вашего-портала.ru/bitrix/tools/transformer_result.php', 
    ],
    'readonly' => false,
],
```

> **Важно:** Если вы используете `SECURITY_TOKEN`, добавьте его в `serviceUrl`:
> `'serviceUrl' => 'https://pdf.your-company.ru/?token=my_secret_token_abc123',`

### Проверить работу в PHP-консоли Битрикса

Если документы не создаются, вы можете диагностировать настройки, выполнив этот код в командной PHP-строке Битрикса:

```php
if (\Bitrix\Main\Loader::includeModule('transformer')) {
    echo "Service URL: " . \Bitrix\Transformer\TransformerManager::getServiceUrl();
}
```

---



## Особенности Архитектуры (для разработчиков)

Проект реализует специфичный протокол обмена с модулем `bitrix/modules/transformer`.
В процессе анализа исходного кода (`TransformManager.php`) было выяснено, что успешная конвертация требует **3-этапного** процесса:

1.  **POST `upload=where`**: Запрос к Битриксу "куда положить файл?". Битрикс возвращает JSON с абсолютным путем.
2.  **POST `upload=filename`**: Загрузка контента файла. В параметре `file_name` нужно передать тот самый абсолютный путь из шага 1.
3.  **POST `finish=y`**: Команда завершения. В массиве `result[files]` нужно передать тот же абсолютный путь.

**Критически важно**: Массив файлов в команде Finish должен быть ассоциативным с ключом `pdf`.
Пример: `result[files][pdf] = /absolute/path/to/file.pdf`.

Если отправить просто массив `['path']`, Битрикс не найдет файл по ключу расширения и молча проигнорирует результат (вернет `success: OK`, но документ не обновится).

---

## Лицензия

Этот проект распространяется под лицензией **Apache License 2.0**.
Основано на идеях [AlexSuperStar/Bitrix24DocxToPdf](https://github.com/AlexSuperStar/Bitrix24DocxToPdf).
Модификации и улучшения архитектуры выполнены в рамках open-source вклада (2025).
