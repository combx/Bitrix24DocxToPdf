# Bitrix24 DocxToPdf Converter (Microservice Edition)

Этот проект представляет собой **локальный сервер конвертации документов** для Битрикс24 (Коробочная версия).
Он заменяет собой стандартный внешний конвертер Битрикс, позволяя генерировать PDF документы (Счета, Акты и т.д.) полностью на вашем сервере.

> **Модернизированная версия**: Полностью переписанная архитектура исходного проекта [Bitrix24DocxToPdf](https://github.com/AlexSuperStar/Bitrix24DocxToPdf). Добавлена поддержка Gotenberg, автоматический SSL и Docker-compose «все-в-одном».

## Преимущества

1.  **Приватность**: Ваши документы не уходят во внешние облака.
2.  **Скорость**: Работает внутри вашей сети или на быстром VPS.
3.  **Стабильность**: Использует промышленный движок **Gotenberg** (LibreOffice + Chrome API).
4.  **Простота**: Автоматическое получение **SSL сертификатов** (HTTPS) через Caddy. Не нужно настраивать Nginx.
5.  **Надежность**: Система очередей RabbitMQ гарантирует, что конвертация не "положит" ваш сервер при большой нагрузке.

---

## Требования

Для запуска вам понадобится отдельный сервер (VPS) с установленным Docker.
Подойдет любой сервер с Ubuntu 20.04/22.04 и минимум 2GB RAM.

### Установка Docker (Ubuntu)
Если на сервере еще нет Docker, выполните команды:

```bash
# Установка Docker
curl -fsSL https://get.docker.com -o get-docker.sh
sudo sh get-docker.sh

# Установка Docker Compose
sudo apt-get update
sudo apt-get install docker-compose-plugin
```

---

## Установка и Запуск

Выполните эти команды на вашем сервере (под root или sudo):

### 1. Скачивание
Клонируйте репозиторий:
```bash
git clone https://github.com/ВашАккаунт/Bitrix24DocxToPdf.git
cd Bitrix24DocxToPdf
```

### 2. Настройка
Создайте файл настроек из примера:
```bash
cp .env.example .env
nano .env
```
Отредактируйте файл `.env`, указав ваш реальный домен и email (для уведомлений о сертификатах):
```dotenv
DOMAIN_NAME=pdf.your-company.ru
ACME_EMAIL=admin@your-company.ru
RABBIT_USER=admin
RABBIT_PASS=сложный_пароль
```
*Важно: Домен должен быть направлен (A-запись DNS) на IP-адрес этого сервера, иначе SSL не выпустится.*

### 3. Запуск
```bash
docker compose up -d --build
```
Эта команда скачает все необходимые компоненты, соберет проект и запустит его. При первом запуске это займет пару минут.

Чтобы проверить, что все работает:
```bash
docker compose logs -f worker
```
Вы должны увидеть сообщение: `Connected. Listening on queue...`

---

## Подключение к Битрикс24

Вам нужно указать Битриксу использовать ваш новый сервер. Это можно сделать двумя способами:

### Способ 1: Через .settings.php (Рекомендуемый)
Этот способ самый надежный.
1.  Зайдите на сервер где установлен Битрикс.
2.  Найдите файл `/home/bitrix/www/bitrix/.settings.php` (путь может отличаться).
3.  Добавьте или измените секцию `transformer`. Если её нет, вставьте её перед закрывающей скобкой `];`:

```php
'transformer' => [
    'value' => [
        'serviceUrl' => 'https://pdf.your-company.ru/', 
        'responseUrl' => 'https://адрес-вашего-портала.ru/bitrix/tools/transformer_result.php', 
    ],
    'readonly' => false,
],
```

### Способ 2: Через Панель Управления (Модуль "Конвертер файлов")
Если у вас в админке есть модуль **"Конвертер файлов"**, вы можете настроить все через интерфейс:
1.  Зайдите в Админку Битрикс24 (`/bitrix/admin`).
2.  Перейдите в **Настройки** -> **Настройки продукта** -> **Настройки модулей** -> **Конвертер файлов** (File Converter).
3.  В поле "Публичный адрес сервиса конвертации" (или похожем) замените текущий адрес на ваш:
    `https://pdf.your-company.ru/bitrix/tools/transformercontroller/add_queue.php?token=ВАШ_ТОКЕН`

---

## Безопасность

Для защиты от несанкционированного использования предусмотрена проверка токена.

1.  В файле `.env` на сервере необходимо добавить:
    ```dotenv
    SECURITY_TOKEN=my_secret_password_123
    ```
2.  Обновите контейнеры: `docker compose up -d`
3.  Сервер будет принимать только запросы, содержащие корректный токен.
4.  В настройках Битрикс ссылку необходимо указывать с параметром `?token=...`:
    *   `https://pdf.your-company.ru/?token=my_secret_password_123`
    *   или `https://pdf.your-company.ru/bitrix/.../add_queue.php?token=my_secret_password_123`

*   `serviceUrl` — это адрес вашего нового сервера конвертации (из шага 2).
*   `responseUrl` — это адрес вашего портала Битрикс24, куда нужно вернуть готовый PDF. Обычно он стандартный, как в примере.

После сохранения файла попробуйте сгенерировать любой документ (Счет/Акт) в CRM.

---

## Лицензия

Этот проект распространяется под лицензией **Apache License 2.0**.
Основано на работе [AlexSuperStar/Bitrix24DocxToPdf](https://github.com/AlexSuperStar/Bitrix24DocxToPdf).
Права на оригинальный код принадлежат Алексею Старикову (2024).
Модификации и улучшения архитектуры выполнены в рамках open-source вклада (2025).
